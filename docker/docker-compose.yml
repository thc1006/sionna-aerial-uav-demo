# =============================================================================
# UAV-ACAR-Sionna Phase 3 Docker Compose
# =============================================================================
# Prerequisites:
#   1. NGC login: ./scripts/ngc_login.sh
#   2. Docker with GPU support: nvidia-docker or --gpus flag
#
# Usage:
#   docker-compose -f docker/docker-compose.yml up -d
#   docker-compose -f docker/docker-compose.yml logs -f
#   docker-compose -f docker/docker-compose.yml down
# =============================================================================

version: "3.8"

services:
  # ===========================================================================
  # Aerial cuBB (CUDA-Accelerated RAN)
  # ===========================================================================
  cubb:
    image: nvcr.io/nvidia/aerial/aerial-cuda-accelerated-ran:25-2-cubb
    container_name: uav-acar-cubb
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    volumes:
      - ../data:/data:ro
      - ../logs:/logs
      - ./config:/config:ro
    # network_mode: host  # Uncomment for DPDK/fronthaul
    ports:
      - "5000:5000"  # cuBB API (if applicable)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "echo", "cubb-health-ok"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # FastAPI Orchestrator
  # ===========================================================================
  orchestrator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.orchestrator
    container_name: uav-acar-orchestrator
    environment:
      - UAV_ACAR_HOST_ROLE=orchestrator
      - CUBB_HOST=cubb
      - CUBB_PORT=5000
    volumes:
      - ../data:/app/data
      - ../logs:/app/logs
      - ../checkpoints:/app/checkpoints:ro
    ports:
      - "8000:8000"
    depends_on:
      - cubb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# Networks (optional, for isolated communication)
# =============================================================================
networks:
  default:
    name: uav-acar-network
